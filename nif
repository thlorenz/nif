#!/usr/bin/env node
const { spawn, execSync } = require('child_process')

try {
  execSync('which chrome-cli', { env: process.env, stdio: 'ignore' })
} catch (err) {
  console.error('No chrome-cli executable found. Please install it using \nbrew install chrome-cli')
  process.exit(1)
}

const args = [ '--inspect', '--debug-brk' ].concat(process.argv.slice(2))
const { stderr } = spawn(process.execPath, args)

let opened = false
stderr.on('data', function(data) {
  if (opened) return

  // Assume the entire url exists in one chunk.
  // Please file an issue if this causes problems :)
  let url = /\b(ws|chrome-devtools)[:]\/\/([^\s]+)\b/.exec(data.toString())
  if (!url) return
  if (url[1] == 'ws') {
    url = 'chrome-devtools://devtools/bundled/inspector.html?ws=' + url[2]
  } else {
    url = url[0] // node < 8
  }

  opened = true
  spawn('chrome-cli', [
    'open', url,
  ], {
    stdio: 'inherit',
  })
})
